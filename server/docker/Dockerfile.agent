# ==============================================================================
# Stage 1: Build Environment - Compiles Go binaries and generates protobuf files
# ==============================================================================
FROM golang:1.24-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    git \
    protobuf \
    protobuf-dev \
    curl \
    ca-certificates

# Install protoc-gen-go plugins
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

WORKDIR /build

# Copy go.mod and go.sum first for better layer caching
COPY go.mod go.sum ./
RUN go mod download

# Copy the rest of the source code
COPY . .

# Generate protobuf files
RUN protoc --go_out=. --go_opt=paths=source_relative \
    --go-grpc_out=. --go-grpc_opt=paths=source_relative \
    proto/service/agent.proto && \
    mv proto/service/agent.pb.go proto/ && \
    mv proto/service/agent_grpc.pb.go proto/

# Build the agent-handler service
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o /agent-handler-service ./cmd/agent-handler

# ==============================================================================
# Stage 2: Runtime Image
# ==============================================================================
FROM alpine:3.20

# Metadata
LABEL maintainer="NexusC2"
LABEL description="Agent handler service for NexusC2 C2 framework"

WORKDIR /app

# Install minimal runtime dependencies and create non-root user
RUN apk add --no-cache \
    ca-certificates && \
    # Create non-root user for security
    addgroup -g 1001 nexus && \
    adduser -D -u 1001 -G nexus nexus && \
    # Create necessary directories
    mkdir -p /app/certs /app/downloads /app/uploads /app/temp /app/logs && \
    # Set ownership
    chown -R nexus:nexus /app && \
    # Remove apk cache
    rm -rf /var/cache/apk/*

# Copy built binary from builder stage
COPY --from=builder --chown=nexus:nexus /agent-handler-service /app/agent-handler-service

# Copy configuration (from server/config.toml)
COPY --chown=nexus:nexus ./config.toml /app/config.toml

# Copy certificates from host (mounted via build context - server/certs/)
COPY --chown=nexus:nexus ./certs/web_server.crt \
                          ./certs/web_server.key \
                          ./certs/rpc_server.crt \
                          ./certs/rpc_server.key \
                          /app/certs/

# Ensure binary is executable
RUN chmod +x /app/agent-handler-service

# Grant capability to bind to privileged ports (< 1024) as non-root
# This allows binding to ports like 443, 80, etc. without running as root
RUN apk add --no-cache libcap && \
    setcap 'cap_net_bind_service=+ep' /app/agent-handler-service && \
    apk del libcap

# Switch to non-root user
USER nexus

# Health check for gRPC service (nc = netcat)
# Note: netcat is not available in non-root Alpine by default
# Alternative: Use gRPC health check or TCP probe externally
# For now, rely on docker-compose health check with nc installed separately or use external probe

# Expose gRPC port (documentation only)
EXPOSE 50051

# Set working directory
WORKDIR /app

# Use exec form to ensure proper signal handling
CMD ["/app/agent-handler-service"]
