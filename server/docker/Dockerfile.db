# Base image
FROM postgres:17

# Environment variables for PostgreSQL
ENV POSTGRES_DB=ops \
    POSTGRES_USER=postgres \
    PGDATA=/var/lib/postgresql/data

# Copy SQL and setup scripts - these will run at container startup on first initialization
COPY db/init.sql /docker-entrypoint-initdb.d/01-init.sql
COPY db/create-tables.sql /docker-entrypoint-initdb.d/02-create-tables.sql
COPY db/setup-permissions.sh /docker-entrypoint-initdb.d/03-setup-permissions.sh

# Copy custom pg_hba.conf that allows Docker network connections
COPY db/custom-pg_hba.conf /docker-entrypoint-initdb.d/99-custom-pg_hba.conf

# Make scripts executable
RUN chmod +x /docker-entrypoint-initdb.d/03-setup-permissions.sh

# Create the necessary directories
RUN mkdir -p /var/run/postgresql && chown -R postgres:postgres /var/run/postgresql && chmod 2777 /var/run/postgresql

# Create a script to copy pg_hba.conf after initialization
RUN echo '#!/bin/bash' > /docker-entrypoint-initdb.d/99-configure-network.sh && \
    echo 'cp /docker-entrypoint-initdb.d/99-custom-pg_hba.conf $PGDATA/pg_hba.conf' >> /docker-entrypoint-initdb.d/99-configure-network.sh && \
    echo "echo \"listen_addresses = '*'\" >> $PGDATA/postgresql.conf" >> /docker-entrypoint-initdb.d/99-configure-network.sh && \
    chmod +x /docker-entrypoint-initdb.d/99-configure-network.sh

# Expose PostgreSQL port
EXPOSE 5432

# Use default postgres entrypoint - initializes DB with runtime environment variables
CMD ["postgres"]
