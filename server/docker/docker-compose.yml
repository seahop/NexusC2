networks:
  c2_internal:
    driver: bridge
    internal: false
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16

services:
  database:
    build:
      context: ..
      dockerfile: docker/Dockerfile.db
      args:
        DB_PASSWORD: ${DB_PASSWORD}
    container_name: database
    networks:
      c2_internal:
        ipv4_address: 172.28.0.2
    environment:
      POSTGRES_DB: ops
      POSTGRES_USER: postgres
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256 --auth-local=scram-sha-256"
    env_file:
      - db/.secrets/.env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "work_mem=16MB"
    # No ports exposed - internal only

  websocket:
    build:
      context: ..
      dockerfile: docker/Dockerfile.websocket
    networks:
      c2_internal:
        ipv4_address: 172.28.0.3
    depends_on:
      database:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allow accessing host network
    environment:
      CONFIG_FILE: /app/config.toml
      HOST_PAYLOADS_PATH: ${PWD}/payloads
      GRPC_ADDRESS: host.docker.internal:50051  # Connect to agent-handler on host network
    env_file:
      - db/.secrets/.env
    # Add host's docker group for socket access
    group_add:
      - ${DOCKER_GID:-984}
    volumes:
      - /shared:/shared
      - ./downloads:/app/downloads
      - ./uploads:/app/uploads
      - ./temp:/app/temp
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
      - ./payloads:/app/payloads:ro
      - ${PWD}/payloads:${PWD}/payloads:ro
    ports:
      - "3131:3131"  # Expose WebSocket for clients
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-k", "-f", "https://localhost:3131/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  agent-handler:
    build:
      context: ..
      dockerfile: docker/Dockerfile.agent
    network_mode: host
    depends_on:
      database:
        condition: service_healthy
    environment:
      CONFIG_FILE: /app/configs/agent.yaml
      # Connect to database via host's docker bridge IP
      DB_HOST: 172.28.0.2
      GRPC_BIND_ADDRESS: 0.0.0.0:50051  # Bind to all interfaces, firewall handles security
    env_file:
      - db/.secrets/.env
    volumes:
      - /shared:/shared
      - ./temp:/app/temp
      - ./downloads:/app/downloads
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "50051"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  builder:
    image: docker_builder:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile.builder
    networks:
      c2_internal:
        ipv4_address: 172.28.0.5
    hostname: builder
    container_name: builder
    volumes:
      - /shared:/shared
      - ./payloads/Darwin:/build/Darwin:ro
      - ./payloads/Linux:/build/Linux:ro
      - ./payloads/Windows:/build/Windows:ro
      - ./payloads/shared:/build/shared:ro
    environment:
      - BUILD=FALSE
      - GOPROXY=https://proxy.golang.org,direct
      - CGO_ENABLED=0
      - OS=linux
      - ARCH=amd64
      - XOR_KEY=dummy_xor_key
      - OUTPUT_FILENAME=test_binary
      - CLIENTID=test_client
      - GET_ROUTE=/api/v1/myget
      - POST_ROUTE=/api/v1/mypost
      - GET_CLIENT_ID_NAME=client
      - GET_CLIENT_ID_FORMAT=%CLIENTID%
      - POST_CLIENT_ID_NAME=client
      - POST_CLIENT_ID_FORMAT=%CLIENTID%
      - POST_SECRET_NAME=id
      - POST_SECRET_FORMAT=%SECRET%
      - USER_AGENT=Mozilla/5.0 (Windows NT 10.0; Win64; x64)
      - CONTENT_TYPE=application/json
      - CUSTOM_HEADERS={"Accept":"*/*","Accept-Language":"en-US,en;q=0.9","Connection":"close","X-Custom-Header":"custom-value","X-Forward-For":"127.0.0.1"}
      - SLEEP=20
      - JITTER=10
      - PUBLIC_KEY=dummy_public_key
      - SECRET=dummy_secret
      - PROTOCOL=https
      - IP=127.0.0.1
      - PORT=8443
      - TOGGLE_CHECK_ENVIRONMENT=false
      - TOGGLE_CHECK_TIME_DISCREPANCY=false
      - TOGGLE_CHECK_MEMORY_PATTERNS=false
      - TOGGLE_CHECK_PARENT_PROCESS=false
      - TOGGLE_CHECK_LOADED_LIBRARIES=false
      - TOGGLE_CHECK_DOCKER_CONTAINER=false
      - TOGGLE_CHECK_PROCESS_LIST=false
    privileged: true
    restart: "no"

volumes:
  shared:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /shared
  postgres_data:
    name: ops_db_data
    driver: local