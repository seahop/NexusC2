<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusC2 System Architecture - Updated with Host Networking</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #e0e0e0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #00d4ff;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .diagram-container {
            background: rgba(30, 30, 50, 0.6);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(0, 212, 255, 0.2);
        }

        .legend {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }

        .legend h3 {
            color: #00d4ff;
            margin-top: 0;
        }

        .legend-item {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        .legend-item strong {
            color: #00d4ff;
        }

        .network-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 8px;
        }

        .badge-bridge {
            background: #4a90e2;
            color: white;
        }

        .badge-host {
            background: #e74c3c;
            color: white;
        }

        .badge-external {
            background: #95a5a6;
            color: white;
        }

        .security-note {
            background: rgba(231, 76, 60, 0.1);
            border-left: 4px solid #e74c3c;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }

        .security-note h4 {
            margin-top: 0;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ NexusC2 System Architecture</h1>
        <div class="subtitle">Updated with Host Networking & Dynamic Port Management</div>

        <div class="diagram-container">
            <div class="mermaid">
graph TB
    subgraph External["üåê External Network"]
        direction LR
        Agent["üíª Compromised Agent<br/>(Implant on Target)"]
        Spacer[" "]
        Client["üë§ Operator Client<br/>(Web Browser)"]
    end

    subgraph HostSystem["üñ•Ô∏è Host System (Docker Host)"]
        subgraph FirewallLayer["üõ°Ô∏è Firewall Layer (iptables)"]
            FW_Allow["‚úÖ Allow: 127.0.0.1<br/>‚úÖ Allow: 172.28.0.0/16<br/>‚ùå Block: External ‚Üí :50051"]
        end

        subgraph HostNetwork["üî¥ Host Network Mode"]
            AgentHandler["‚ö° Agent-Handler<br/>network_mode: host<br/>gRPC: 0.0.0.0:50051<br/>Listeners: Any Port"]
        end

        subgraph DockerBridge["üîµ Docker Bridge Network (172.28.0.0/16)"]
            Database["üóÑÔ∏è PostgreSQL<br/>172.28.0.2:5432<br/>(Internal Only)"]
            Websocket["üåê WebSocket Server<br/>172.28.0.3:3131<br/>(Public)"]
            Builder["üî® Builder Service<br/>172.28.0.5<br/>(On-Demand)"]
        end
    end

    %% External Connections - Separated paths
    Agent <-->|"HTTPS/HTTP<br/>Dynamic Ports"| AgentHandler
    Client <-->|"WSS :3131"| Websocket

    %% Internal Docker Bridge Network
    Websocket <-->|"gRPC :50051<br/>via host.docker.internal"| AgentHandler
    Websocket -->|"PostgreSQL :5432"| Database
    AgentHandler -->|"PostgreSQL :5432<br/>via 172.28.0.2"| Database
    Websocket -.->|"Docker API<br/>Trigger Build"| Builder

    %% Firewall Protection
    FW_Allow -.->|"Protects"| AgentHandler

    %% Styling
    classDef hostNet fill:#e74c3c,stroke:#c0392b,stroke-width:3px,color:#fff
    classDef bridgeNet fill:#4a90e2,stroke:#2980b9,stroke-width:2px,color:#fff
    classDef external fill:#95a5a6,stroke:#7f8c8d,stroke-width:2px,color:#fff
    classDef firewall fill:#f39c12,stroke:#e67e22,stroke-width:3px,color:#000
    classDef spacer fill:none,stroke:none,color:transparent

    class AgentHandler hostNet
    class Database,Websocket,Builder bridgeNet
    class Agent,Client external
    class FW_Allow firewall
    class Spacer spacer
            </div>
        </div>

        <div class="security-note">
            <h4>üîí Security Architecture</h4>
            <p><strong>Firewall Protection:</strong> iptables rules secure gRPC port 50051 from external access while allowing internal Docker container communication via the bridge network (172.28.0.0/16).</p>
            <p><strong>Dynamic Ports:</strong> Agent-handler runs on host network, enabling dynamic listener port creation without container restarts or docker-compose.yml modifications.</p>
        </div>

        <div class="legend">
            <h3>üìã Component Details</h3>

            <div class="legend-item">
                <strong>üî¥ Agent-Handler (Host Network)</strong>
                <span class="network-badge badge-host">HOST</span>
                <ul>
                    <li>Runs with <code>network_mode: host</code> for direct host network access</li>
                    <li>gRPC server binds to <code>0.0.0.0:50051</code> (secured by firewall)</li>
                    <li>Can bind listeners to ANY port dynamically (80, 443, 8080, etc.)</li>
                    <li>Connects to PostgreSQL via bridge IP <code>172.28.0.2</code></li>
                    <li>Handles all agent communications and command execution</li>
                </ul>
            </div>

            <div class="legend-item">
                <strong>üîµ WebSocket Server (Bridge Network)</strong>
                <span class="network-badge badge-bridge">BRIDGE</span>
                <ul>
                    <li>IP: <code>172.28.0.3</code> on bridge network</li>
                    <li>Exposed port: <code>3131</code> for operator clients</li>
                    <li>Connects to agent-handler gRPC via <code>host.docker.internal:50051</code></li>
                    <li>Provides real-time web interface for operators</li>
                    <li>Manages payload building via builder service</li>
                </ul>
            </div>

            <div class="legend-item">
                <strong>üîµ PostgreSQL Database (Bridge Network)</strong>
                <span class="network-badge badge-bridge">BRIDGE</span>
                <ul>
                    <li>IP: <code>172.28.0.2</code> on bridge network</li>
                    <li><strong>Not exposed</strong> to host - internal only</li>
                    <li>Stores: agents, listeners, commands, results, logs</li>
                    <li>Accessed by all services via bridge network</li>
                </ul>
            </div>

            <div class="legend-item">
                <strong>üîµ Builder Service (Bridge Network)</strong>
                <span class="network-badge badge-bridge">BRIDGE</span>
                <ul>
                    <li>IP: <code>172.28.0.5</code> on bridge network</li>
                    <li>On-demand payload compilation service</li>
                    <li>Supports: Windows, Linux, macOS payloads</li>
                    <li>Compiles with custom configurations (obfuscation, encryption)</li>
                </ul>
            </div>

            <div class="legend-item">
                <strong>üõ°Ô∏è Firewall Rules (iptables)</strong>
                <ul>
                    <li>Chain: <code>NEXUSC2_GRPC</code></li>
                    <li>‚úÖ Allow: <code>127.0.0.1</code> ‚Üí port 50051 (localhost)</li>
                    <li>‚úÖ Allow: <code>172.28.0.0/16</code> ‚Üí port 50051 (Docker containers)</li>
                    <li>‚ùå Drop: All other sources ‚Üí port 50051 (external networks)</li>
                    <li>Applied automatically during setup via <code>setup-firewall.sh</code></li>
                </ul>
            </div>

            <div class="legend-item">
                <strong>üåê External Components</strong>
                <span class="network-badge badge-external">EXTERNAL</span>
                <ul>
                    <li><strong>Agents:</strong> Connect to agent-handler via HTTP/HTTPS on dynamic ports</li>
                    <li><strong>Operator Clients:</strong> Connect to websocket server via WSS on port 3131</li>
                    <li>All external connections are encrypted (TLS/SSL)</li>
                </ul>
            </div>
        </div>

        <div class="legend">
            <h3>üîÑ Communication Flow</h3>

            <div class="legend-item">
                <strong>1. Operator ‚Üí System</strong>
                <ol>
                    <li>Operator connects to WebSocket server (<code>wss://server:3131</code>)</li>
                    <li>WebSocket authenticates and establishes session</li>
                    <li>Operator sends commands via web interface</li>
                </ol>
            </div>

            <div class="legend-item">
                <strong>2. Command Execution Flow</strong>
                <ol>
                    <li>WebSocket receives command from operator</li>
                    <li>WebSocket calls agent-handler gRPC API (<code>host.docker.internal:50051</code>)</li>
                    <li>Agent-handler stores command in PostgreSQL</li>
                    <li>Agent checks in and retrieves pending commands</li>
                    <li>Agent executes command and sends results</li>
                    <li>Agent-handler stores results in PostgreSQL</li>
                    <li>Agent-handler streams results to WebSocket via gRPC bidirectional stream</li>
                    <li>WebSocket pushes results to operator in real-time</li>
                </ol>
            </div>

            <div class="legend-item">
                <strong>3. Dynamic Listener Creation</strong>
                <ol>
                    <li>Operator requests listener creation (e.g., HTTPS on port 443)</li>
                    <li>WebSocket sends request to agent-handler via gRPC</li>
                    <li>Agent-handler binds to requested port on host network</li>
                    <li>Listener details stored in PostgreSQL</li>
                    <li><strong>No docker-compose.yml modification needed!</strong></li>
                    <li><strong>No container restart needed!</strong></li>
                </ol>
            </div>

            <div class="legend-item">
                <strong>4. Payload Building</strong>
                <ol>
                    <li>Operator requests payload via WebSocket</li>
                    <li>WebSocket triggers builder service via Docker API</li>
                    <li>Builder compiles payload with custom config</li>
                    <li>Compiled payload saved to shared volume</li>
                    <li>Operator downloads via WebSocket</li>
                </ol>
            </div>
        </div>

        <div class="legend">
            <h3>üéØ Key Advantages of This Architecture</h3>

            <div class="legend-item">
                <strong>‚úÖ Dynamic Port Management</strong>
                <p>Agent-handler can bind to any port without editing configuration files or restarting containers. Create listeners on ports 80, 443, 8080, 9001, or any other port on the fly.</p>
            </div>

            <div class="legend-item">
                <strong>üîí Security Isolation</strong>
                <p>gRPC port 50051 is protected by firewall rules, blocking external access while allowing internal Docker containers to communicate. Database is completely internal with no external exposure.</p>
            </div>

            <div class="legend-item">
                <strong>‚ö° High Performance</strong>
                <p>Host networking eliminates Docker bridge network overhead for agent-handler, providing near-native network performance for handling large numbers of agents.</p>
            </div>

            <div class="legend-item">
                <strong>üîÑ Auto-Reconnection</strong>
                <p>Stream manager handles automatic reconnection between WebSocket and agent-handler services. gRPC bidirectional streams provide real-time command and result flow.</p>
            </div>

            <div class="legend-item">
                <strong>üì¶ Service Isolation</strong>
                <p>Internet-facing WebSocket service has no Docker socket access. Builder service runs in isolated container with minimal privileges. Defense in depth security model.</p>
            </div>
        </div>

        <div class="legend">
            <h3>üöÄ Deployment</h3>
            <pre style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 5px; overflow-x: auto;">
# Initial setup (includes firewall rules)
sudo ./scripts/setup.sh

# Start services
cd server/docker
docker compose up -d

# Verify firewall rules
sudo iptables -L NEXUSC2_GRPC -n -v

# Check services
docker compose ps
            </pre>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });
    </script>
</body>
</html>
